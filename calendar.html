<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Studio Calendar ‚Ä¢ Elite Dance</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --brand:#EC4899; } /* pink from your example; change anytime */
  </style>
</head>
<body class="bg-white text-gray-900">
  <main class="max-w-6xl mx-auto px-4 py-10">
    <h1 class="text-4xl font-bold mb-2">Studio Calendar</h1>
    <p class="text-gray-600 mb-8">Updated automatically from Google Calendar.</p>

    <div id="cal" class="w-full"></div>
  </main>

<script>
  const calEl = document.getElementById('cal')
  const TZ = 'America/Chicago'

  // ---- State ----
  const state = {
    cursor: new Date(),    // anchor for Month view
    view: 'day',           // 'day' | 'month'
    events: [],
  }

  // ---- TZ helpers (America/Chicago) ----
  function ymdChicagoFromISO(iso) {
    // Get YYYY-MM-DD for a timestamp in America/Chicago
    const parts = new Intl.DateTimeFormat('en-CA', {
      timeZone: TZ, year: 'numeric', month: '2-digit', day: '2-digit'
    }).formatToParts(new Date(iso))
    const y = parts.find(p=>p.type==='year').value
    const m = parts.find(p=>p.type==='month').value
    const d = parts.find(p=>p.type==='day').value
    return `${y}-${m}-${d}`
  }
  function ymdChicagoFromDate(d) {
    const parts = new Intl.DateTimeFormat('en-CA', {
      timeZone: TZ, year: 'numeric', month: '2-digit', day: '2-digit'
    }).formatToParts(d)
    const y = parts.find(p=>p.type==='year').value
    const m = parts.find(p=>p.type==='month').value
    const dd = parts.find(p=>p.type==='day').value
    return `${y}-${m}-${dd}`
  }
  function chicagoTime(iso) {
    return new Intl.DateTimeFormat('en-US', {
      timeZone: TZ, hour: 'numeric', minute: '2-digit'
    }).format(new Date(iso))
  }
  function chicagoMonthYear(d) {
    return new Intl.DateTimeFormat('en-US', { timeZone: TZ, month:'long', year:'numeric' }).format(d)
  }
  function chicagoWeekdayIndex(d) {
    // 0=Sun..6=Sat in Chicago
    return new Intl.DateTimeFormat('en-US', { timeZone: TZ, weekday:'short' })
      .formatToParts(d)
      // map to index using a Date in local just for lookup
      // simpler: compute with formatted weekday string
  }

  // ---- Fetch events for current window ----
  async function fetchEvents(){
    let timeMin, timeMax
    if (state.view === 'day') {
      const now = new Date()
      // build a Chicago "today" span (00:00‚Äì23:59 in Chicago)
      const ymd = ymdChicagoFromDate(now)
      const s = new Date(`${ymd}T00:00:00`)
      const e = new Date(`${ymd}T23:59:59`)
      timeMin = s.toISOString(); timeMax = e.toISOString()
    } else { // month
      const start = new Date(state.cursor.getFullYear(), state.cursor.getMonth(), 1)
      const end = new Date(state.cursor.getFullYear(), state.cursor.getMonth()+1, 0, 23, 59, 59)
      timeMin = start.toISOString(); timeMax = end.toISOString()
    }

    const r = await fetch(`/api/events?timeMin=${encodeURIComponent(timeMin)}&timeMax=${encodeURIComponent(timeMax)}`)
    const json = await r.json()
    state.events = (json.events || [])
      // normalize: keep all-day as-is; ensure sorting by Chicago time
      .sort((a,b)=> new Date(a.start) - new Date(b.start))
  }

  // ---- Group by Chicago calendar day ----
  function groupByChicagoDay(){
    const map = new Map()
    for (const e of state.events) {
      // Use date-only string as-is for all-day, else derive from dateTime in Chicago
      const key = (e.start.length === 10) ? e.start : ymdChicagoFromISO(e.start)
      if (!map.has(key)) map.set(key, [])
      map.get(key).push(e)
    }
    return map
  }

  // ---- Month grid days (42 cells) ----
  function buildMonthDays(cursor){
    const start = new Date(cursor.getFullYear(), cursor.getMonth(), 1)
    const end = new Date(cursor.getFullYear(), cursor.getMonth()+1, 0)
    const firstWeekday = new Date(start).getDay() // (close enough visually)
    const days = []
    // backfill
    for (let i=0;i<firstWeekday;i++){ const d=new Date(start); d.setDate(start.getDate()-(firstWeekday-i)); days.push(d) }
    // month days
    for (let d=new Date(start); d<=end; d.setDate(d.getDate()+1)) days.push(new Date(d))
    // forward to 42
    while (days.length<42){ const d=new Date(days[days.length-1]); d.setDate(d.getDate()+1); days.push(d) }
    return days
  }

  // ---- Render ----
  function render(){
    calEl.innerHTML = ''

    // Header
    const header = document.createElement('div')
    header.className = 'flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4'
    header.innerHTML = `
      <div class="flex items-center gap-2">
        <h2 class="text-3xl font-bold">${state.view==='month' ? chicagoMonthYear(state.cursor) : 'Studio Calendar'}</h2>
        ${state.view==='month' ? `
          <div class="hidden sm:flex gap-2 ml-3">
            <button class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200" id="btnToday">Today</button>
            <button class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200" id="btnPrev">Prev</button>
            <button class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200" id="btnNext">Next</button>
          </div>` : ''}
      </div>
      <div class="flex items-center gap-2">
        <label for="viewSel" class="text-sm text-gray-600">View</label>
        <select id="viewSel" class="px-3 py-2 rounded-xl border">
          <option value="day"${state.view==='day'?' selected':''}>Day</option>
          <option value="month"${state.view==='month'?' selected':''}>Month</option>
        </select>
      </div>
    `
    calEl.appendChild(header)
    header.querySelector('#viewSel').onchange = (e)=>{ state.view = e.target.value; boot() }
    if (state.view==='month'){
      header.querySelector('#btnToday').onclick = ()=>{ state.cursor = new Date(); boot() }
      header.querySelector('#btnPrev').onclick = ()=>{ const d=new Date(state.cursor); d.setMonth(d.getMonth()-1); state.cursor=d; boot() }
      header.querySelector('#btnNext').onclick = ()=>{ const d=new Date(state.cursor); d.setMonth(d.getMonth()+1); state.cursor=d; boot() }
    }

    if (state.view === 'day') renderDay()
    else renderMonth()
  }

  function renderDay(){
    const todayYMD = ymdChicagoFromDate(new Date())
    const byDay = groupByChicagoDay()
    const list = byDay.get(todayYMD) || []

    const wrap = document.createElement('div')
    wrap.className = 'space-y-3'

    if (!list.length) {
      wrap.innerHTML = `<div class="text-gray-600">No events today.</div>`
      calEl.appendChild(wrap)
      return
    }

    for (const ev of list) {
      const isTimed = ev.start.length > 10
      const card = document.createElement('a')
      card.href = ev.htmlLink || '#'
      card.target = '_blank'
      card.rel = 'noreferrer'
      card.className = 'block border rounded-2xl p-4 hover:shadow transition'
      card.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="font-semibold text-[color:var(--brand)]">${escapeHtml(ev.title || 'Untitled')}</div>
            ${ev.location ? `<div class="text-sm text-gray-600 mt-1">üìç ${escapeHtml(ev.location)}</div>` : ''}
            ${ev.description ? `<div class="text-sm text-gray-700 mt-2 whitespace-pre-line">${escapeHtml(ev.description)}</div>` : ''}
          </div>
          <div class="text-sm text-gray-700 whitespace-nowrap">
            ${isTimed ? `${chicagoTime(ev.start)} ‚Äì ${chicagoTime(ev.end)}` : 'All day'}
          </div>
        </div>
      `
      wrap.appendChild(card)
    }

    calEl.appendChild(wrap)
  }

  function renderMonth(){
    // Weekday header
    const weekdayRow = document.createElement('div')
    weekdayRow.className = 'grid grid-cols-7 text-xs font-medium text-gray-500 uppercase tracking-wide mb-2'
    weekdayRow.innerHTML = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d=>`<div class="px-2 py-1">${d}</div>`).join('')
    calEl.appendChild(weekdayRow)

    const days = buildMonthDays(state.cursor)
    const byDay = groupByChicagoDay()
    const grid = document.createElement('div')
    grid.className = 'grid grid-cols-7 gap-2'

    const todayYMD = ymdChicagoFromDate(new Date())
    const monthY = state.cursor.getFullYear(), monthM = state.cursor.getMonth()

    for (const d of days){
      const inMonth = (d.getMonth()===monthM && d.getFullYear()===monthY)
      const ymd = ymdChicagoFromDate(d)
      const isToday = (ymd === todayYMD)
      const events = byDay.get(ymd) || []

      const cell = document.createElement('button')
      cell.className = `rounded-2xl border p-2 text-left transition shadow-sm hover:shadow ${inMonth ? 'bg-white' : 'bg-gray-50'} ${isToday ? 'border-[color:var(--brand)]' : 'border-gray-200'}`
      cell.style.minHeight = '140px'

      cell.innerHTML = `
        <div class="flex items-center justify-between">
          <span class="text-sm ${inMonth?'text-gray-900':'text-gray-400'}">${d.getDate()}</span>
          ${events.length ? `<span class="text-[10px] px-2 py-0.5 rounded-full bg-[color:var(--brand)]/10 text-[color:var(--brand)]">${events.length}</span>` : '<span></span>'}
        </div>
      `
      const list = document.createElement('div')
      list.className = 'mt-2 space-y-1'
      let shown = 0
      for (const ev of events) {
        if (shown >= 3) break
        const pill = document.createElement('div')
        pill.className = 'text-[12px] px-2 py-1 rounded-lg bg-black/5 truncate'
        const isTimed = ev.start.length > 10
        const timePrefix = isTimed ? `${chicagoTime(ev.start)} ‚Äî ` : ''
        pill.textContent = `${timePrefix}${ev.title}`
        pill.title = ev.title
        list.appendChild(pill)
        shown++
      }
      if (events.length > shown) {
        const more = document.createElement('div')
        more.className = 'text-[11px] text-gray-500'
        more.textContent = `+${events.length - shown} more`
        list.appendChild(more)
      }

      cell.addEventListener('click', ()=> openPanel(d, events))
      cell.appendChild(list)
      grid.appendChild(cell)
    }

    calEl.appendChild(grid)

    // Slide-over overlay (inject once)
    if (!document.getElementById('overlay')) {
      const overlay = document.createElement('div')
      overlay.id = 'overlay'
      overlay.className = 'fixed inset-0 z-50 hidden'
      overlay.innerHTML = `
        <div class="absolute inset-0 bg-black/30" onclick="closePanel()"></div>
        <div class="absolute right-0 top-0 h-full w-full max-w-md bg-white shadow-xl p-6 flex flex-col">
          <div class="flex items-center justify-between">
            <h3 id="panel-title" class="text-xl font-bold"></h3>
            <button onclick="closePanel()" class="p-2 rounded-xl hover:bg-gray-100">‚úï</button>
          </div>
          <div id="panel-body" class="mt-4 space-y-3 overflow-y-auto"></div>
        </div>
      `
      document.body.appendChild(overlay)
    }
  }

  // Panel helpers
  window.closePanel = function(){
    document.getElementById('overlay').classList.add('hidden')
  }
  window.openPanel = function(dayDate, events){
    document.getElementById('panel-title').textContent =
      new Intl.DateTimeFormat('en-US',{ timeZone: TZ, weekday:'long', month:'long', day:'numeric'}).format(dayDate)
    const body = document.getElementById('panel-body')
    body.innerHTML = ''
    if(!events.length){ body.innerHTML = '<div class="text-gray-500">No events.</div>'; document.getElementById('overlay').classList.remove('hidden'); return }
    for(const ev of events){
      const a = document.createElement('a')
      a.href = ev.htmlLink || '#'
      a.target = '_blank'
      a.rel = 'noreferrer'
      a.className = 'block border rounded-2xl p-3 hover:shadow'
      const isTimed = ev.start.length > 10
      a.innerHTML = `
        <div class="font-semibold text-[color:var(--brand)]">${escapeHtml(ev.title || 'Untitled')}</div>
        ${ev.location ? `<div class="text-sm text-gray-600 mt-1">üìç ${escapeHtml(ev.location)}</div>` : ''}
        ${isTimed ? `<div class="text-sm text-gray-600 mt-1">üïí ${chicagoTime(ev.start)} ‚Äì ${chicagoTime(ev.end)}</div>` : '<div class="text-sm text-gray-600 mt-1">All day</div>'}
        ${ev.description ? `<div class="text-sm text-gray-700 mt-2 whitespace-pre-line">${escapeHtml(ev.description)}</div>` : ''}
      `
      body.appendChild(a)
    }
    document.getElementById('overlay').classList.remove('hidden')
  }

  // Utils
  function escapeHtml(s){ return s?.replace(/[&<>\"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])) }

  // Boot
  async function boot(){ await fetchEvents(); render() }
  boot()
</script>
</body>
</html>