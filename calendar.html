<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Studio Calendar ‚Ä¢ Elite Dance</title>

  <!-- Tailwind CSS (load first) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind theme extensions (ok before or after; after is fine with CDN) -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'dance-purple': '#8B5CF6',
            'dance-pink':   '#EC4899',
            'dance-blue':   '#3B82F6',
            'dance-gold':   '#F59E0B',
            'dance-green':  '#32B486'
          }
        }
      }
    }
  </script>

  <!-- Font (Poppins) -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Site-wide tweaks -->
  <style>
    body { font-family: 'Poppins', sans-serif; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-dance-purple/5 via-dance-pink/5 to-dance-blue/5 text-gray-900">
  <main class="max-w-6xl mx-auto px-4 py-12">
    <h1 class="text-4xl font-bold mb-4 text-center text-transparent bg-clip-text bg-gradient-to-r from-dance-purple to-dance-pink">Studio Calendar</h1>
   <p class="text-center text-gray-600 mb-8">Updated automatically from Google Calendar.</p>

    <div class="bg-white rounded-2xl shadow-xl border border-gray-200 p-6">
  <div id="cal"></div>
</div>
  </main>

<script>
  const calEl = document.getElementById('cal')
  const TZ = 'America/Chicago'

  // ---- State ----
  const state = {
    cursor: new Date(),   // anchor for Month
    view: 'day',          // 'day' (agenda) | 'month'
    events: [],
  }

  // ---- Chicago (TZ) helpers ----
  function ymdChicagoFromISO(iso) {
    const parts = new Intl.DateTimeFormat('en-CA', {
      timeZone: TZ, year: 'numeric', month: '2-digit', day: '2-digit'
    }).formatToParts(new Date(iso))
    const y = parts.find(p=>p.type==='year').value
    const m = parts.find(p=>p.type==='month').value
    const d = parts.find(p=>p.type==='day').value
    return `${y}-${m}-${d}`
  }
  function ymdChicagoFromDate(d) {
    const parts = new Intl.DateTimeFormat('en-CA', {
      timeZone: TZ, year: 'numeric', month: '2-digit', day: '2-digit'
    }).formatToParts(d)
    const y = parts.find(p=>p.type==='year').value
    const m = parts.find(p=>p.type==='month').value
    const dd = parts.find(p=>p.type==='day').value
    return `${y}-${m}-${dd}`
  }
  function chicagoTime(iso) {
    return new Intl.DateTimeFormat('en-US', {
      timeZone: TZ, hour: 'numeric', minute: '2-digit'
    }).format(new Date(iso))
  }
  function chicagoMonthYear(d) {
    return new Intl.DateTimeFormat('en-US', { timeZone: TZ, month:'long', year:'numeric' }).format(d)
  }

  // ---- Fetch events (window depends on view) ----
  async function fetchEvents(){
    let timeMin, timeMax
    const now = new Date()

    if (state.view === 'day') {
      // Agenda: show from **today** through the next 200 days
      const startYMD = ymdChicagoFromDate(now)
      const start = new Date(`${startYMD}T00:00:00`)
      const end = new Date(start); end.setDate(end.getDate() + 200); end.setHours(23,59,59,999)
      timeMin = start.toISOString(); timeMax = end.toISOString()
    } else {
      const start = new Date(state.cursor.getFullYear(), state.cursor.getMonth(), 1)
      const end = new Date(state.cursor.getFullYear(), state.cursor.getMonth()+1, 0, 23, 59, 59)
      timeMin = start.toISOString(); timeMax = end.toISOString()
    }

    const r = await fetch(`/api/events?timeMin=${encodeURIComponent(timeMin)}&timeMax=${encodeURIComponent(timeMax)}`)
    const json = await r.json()
    state.events = (json.events || []).sort((a,b)=> new Date(a.start) - new Date(b.start))
  }

  // ---- Group by Chicago day (keys sorted) ----
  function groupByChicagoDaySorted(){
    const map = new Map()
    for (const e of state.events) {
      const key = (e.start.length === 10) ? e.start : ymdChicagoFromISO(e.start)
      if (!map.has(key)) map.set(key, [])
      map.get(key).push(e)
    }
    const keys = Array.from(map.keys()).sort()
    return { map, keys }
  }

  // ---- Month grid helpers ----
  function buildMonthDays(cursor){
    const start = new Date(cursor.getFullYear(), cursor.getMonth(), 1)
    const end = new Date(cursor.getFullYear(), cursor.getMonth()+1, 0)
    const firstWeekday = start.getDay() // 0=Sun..6=Sat
    const days = []
    for (let i=0;i<firstWeekday;i++){ const d=new Date(start); d.setDate(start.getDate()-(firstWeekday-i)); days.push(d) }
    for (let d=new Date(start); d<=end; d.setDate(d.getDate()+1)) days.push(new Date(d))
    while (days.length<42){ const d=new Date(days[days.length-1]); d.setDate(d.getDate()+1); days.push(d) }
    return days
  }

  // ---- Render root ----
  function render(){
    calEl.innerHTML = ''

    // Header
    const header = document.createElement('div')
    header.className = 'flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4'
    header.innerHTML = `
      <div class="flex items-center gap-3">
        <h3 class="text-3xl font-bold text-dance-purple">${state.view==='month' ? chicagoMonthYear(state.cursor) : 'Agenda View'}</h3>
        ${state.view==='month' ? `
          <div class="hidden sm:flex gap-2 ml-1">
            <button class="px-3 py-2 rounded-xl bg-gradient-to-r from-dance-purple to-dance-pink text-white hover:opacity-90" id="btnToday">Today</button>
            <button class="px-3 py-2 rounded-xl bg-gradient-to-r from-dance-purple to-dance-pink text-white hover:opacity-90" id="btnPrev">Prev</button>
            <button class="px-3 py-2 rounded-xl bg-gradient-to-r from-dance-purple to-dance-pink text-white hover:opacity-90" id="btnNext">Next</button>
          </div>` : ''}
      </div>
      <div class="flex items-center gap-2">
        <label for="viewSel" class="text-sm text-gray-600">View</label>
        <select id="viewSel" class="px-3 py-2 rounded-xl border">
          <option value="day"${state.view==='day'?' selected':''}>Day (List)</option>
          <option value="month"${state.view==='month'?' selected':''}>Month</option>
        </select>
      </div>
    `
    calEl.appendChild(header)
    header.querySelector('#viewSel').onchange = (e)=>{ state.view = e.target.value; boot() }
    if (state.view==='month'){
      header.querySelector('#btnToday').onclick = ()=>{ state.cursor = new Date(); boot() }
      header.querySelector('#btnPrev').onclick = ()=>{ const d=new Date(state.cursor); d.setMonth(d.getMonth()-1); state.cursor=d; boot() }
      header.querySelector('#btnNext').onclick = ()=>{ const d=new Date(state.cursor); d.setMonth(d.getMonth()+1); state.cursor=d; boot() }
    }

    if (state.view === 'day') renderAgenda()
    else renderMonth()
  }

  // ---- Day = Agenda list (only dates that have events) ----
  function renderAgenda(){
    const { map, keys } = groupByChicagoDaySorted()
    const wrap = document.createElement('div')
    wrap.className = 'space-y-6'

    if (!keys.length) {
      wrap.innerHTML = `<div class="text-gray-600">No upcoming events.</div>`
      calEl.appendChild(wrap)
      return
    }

    for (const key of keys) {
      const dateObj = new Date(`${key}T12:00:00`) // noon to avoid DST edge; display uses TZ anyway
      const heading = new Intl.DateTimeFormat('en-US', {
        timeZone: TZ, weekday:'long', month:'long', day:'numeric'
      }).format(dateObj)

      const section = document.createElement('section')
      section.className = 'bg-white border border-gray-200 rounded-2xl p-4 shadow-sm'
      section.innerHTML = `
        <div class="flex items-baseline justify-between mb-3">
          <h3 class="text-xl font-semibold text-gray-900">${heading}</h3>
          <span class="text-sm text-gray-500">${map.get(key).length} ${map.get(key).length===1?'event':'events'}</span>
        </div>
      `
      const list = document.createElement('div')
      list.className = 'divide-y divide-gray-100'

      for (const ev of map.get(key)) {
        const isTimed = ev.start.length > 10
        const row = document.createElement('a')
        row.href = ev.htmlLink || '#'
        row.target = '_blank'
        row.rel = 'noreferrer'
        row.className = 'flex items-start gap-4 py-3 group'
        row.innerHTML = `
          <div class="text-sm text-gray-700 whitespace-nowrap min-w-[120px]">
            ${isTimed ? `${chicagoTime(ev.start)} ‚Äì ${chicagoTime(ev.end)}` : 'All day'}
          </div>
          <div class="flex-1">
            <div class="font-medium text-dance-purple group-hover:underline">${escapeHtml(ev.title || 'Untitled')}</div>
            ${ev.location ? `<div class="text-sm text-gray-600 mt-0.5">üìç ${escapeHtml(ev.location)}</div>` : ''}
            ${ev.description ? `<div class="text-sm text-gray-700 mt-1 whitespace-pre-line">${escapeHtml(ev.description)}</div>` : ''}
          </div>
        `
        list.appendChild(row)
      }

      section.appendChild(list)
      wrap.appendChild(section)
    }

    calEl.appendChild(wrap)
  }

  // ---- Month grid with clearer borders ----
  function renderMonth(){
    // Weekday header
    const weekdayRow = document.createElement('div')
    weekdayRow.className = 'grid grid-cols-7 text-xs font-medium text-gray-500 uppercase tracking-wide mb-2'
    weekdayRow.innerHTML = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d=>`<div class="px-2 py-1">${d}</div>`).join('')
    calEl.appendChild(weekdayRow)

    const days = buildMonthDays(state.cursor)
    const { map } = groupByChicagoDaySorted()
    const grid = document.createElement('div')
    grid.className = 'grid grid-cols-7 gap-0 rounded-2xl overflow-hidden border border-gray-200' /* outer frame */

    const todayYMD = ymdChicagoFromDate(new Date())
    const monthY = state.cursor.getFullYear(), monthM = state.cursor.getMonth()

    for (const d of days){
      const inMonth = (d.getMonth()===monthM && d.getFullYear()===monthY)
      const ymd = ymdChicagoFromDate(d)
      const isToday = (ymd === todayYMD)
      const events = map.get(ymd) || []

      const cell = document.createElement('button')
      // NOTE: stronger grid/border styling for clear day boxes:
      cell.className = `relative text-left p-2 transition hover:bg-gray-50
                        ${inMonth ? 'bg-white' : 'bg-gray-50'}
                        ${isToday ? 'ring-2 ring-dance-pink ring-offset-0' : ''}
                        border border-gray-200`  /* per-cell border */
      cell.style.minHeight = '140px'

      cell.innerHTML = `
        <div class="flex items-center justify-between">
          <span class="text-sm ${inMonth?'text-gray-900':'text-gray-400'}">${d.getDate()}</span>
          ${events.length ? `<span class="text-[10px] px-2 py-0.5 rounded-full bg-dance-purple/10 text-dance-purple">${events.length}</span>` : '<span></span>'}
        </div>
      `
      const list = document.createElement('div')
      list.className = 'mt-2 space-y-1'
      let shown = 0
      for (const ev of events) {
        if (shown >= 3) break
        const pill = document.createElement('div')
        pill.className = 'text-[12px] px-2 py-1 rounded-lg bg-gray-100 truncate'
        const isTimed = ev.start.length > 10
        const timePrefix = isTimed ? `${chicagoTime(ev.start)} ‚Äî ` : ''
        pill.textContent = `${timePrefix}${ev.title}`
        pill.title = ev.title
        list.appendChild(pill)
        shown++
      }
      if (events.length > shown) {
        const more = document.createElement('div')
        more.className = 'text-[11px] text-gray-500'
        more.textContent = `+${events.length - shown} more`
        list.appendChild(more)
      }

      cell.addEventListener('click', ()=> openPanel(d, events))
      cell.appendChild(list)
      grid.appendChild(cell)
    }

    calEl.appendChild(grid)

    // Slide-over overlay (inject once)
    if (!document.getElementById('overlay')) {
      const overlay = document.createElement('div')
      overlay.id = 'overlay'
      overlay.className = 'fixed inset-0 z-50 hidden'
      overlay.innerHTML = `
        <div class="absolute inset-0 bg-black/30" onclick="closePanel()"></div>
        <div class="absolute right-0 top-0 h-full w-full max-w-md bg-white shadow-xl p-6 flex flex-col">
          <div class="flex items-center justify-between">
            <h3 id="panel-title" class="text-xl font-bold"></h3>
            <button onclick="closePanel()" class="p-2 rounded-xl hover:bg-gray-100">‚úï</button>
          </div>
          <div id="panel-body" class="mt-4 space-y-3 overflow-y-auto"></div>
        </div>
      `
      document.body.appendChild(overlay)
    }
  }

  // Panel helpers
  window.closePanel = function(){
    document.getElementById('overlay').classList.add('hidden')
  }
  window.openPanel = function(dayDate, events){
    document.getElementById('panel-title').textContent =
      new Intl.DateTimeFormat('en-US',{ timeZone: TZ, weekday:'long', month:'long', day:'numeric'}).format(dayDate)
    const body = document.getElementById('panel-body')
    body.innerHTML = ''
    if(!events.length){ body.innerHTML = '<div class="text-gray-500">No events.</div>'; document.getElementById('overlay').classList.remove('hidden'); return }
    for(const ev of events){
      const a = document.createElement('a')
      a.href = ev.htmlLink || '#'
      a.target = '_blank'
      a.rel = 'noreferrer'
      a.className = 'block border rounded-2xl p-3 hover:shadow'
      const isTimed = ev.start.length > 10
      a.innerHTML = `
        <div class="font-semibold text-dance-purple">${escapeHtml(ev.title || 'Untitled')}</div>
        ${ev.location ? `<div class="text-sm text-gray-600 mt-1">üìç ${escapeHtml(ev.location)}</div>` : ''}
        ${isTimed ? `<div class="text-sm text-gray-600 mt-1">üïí ${chicagoTime(ev.start)} ‚Äì ${chicagoTime(ev.end)}</div>` : '<div class="text-sm text-gray-600 mt-1">All day</div>'}
        ${ev.description ? `<div class="text-sm text-gray-700 mt-2 whitespace-pre-line">${escapeHtml(ev.description)}</div>` : ''}
      `
      body.appendChild(a)
    }
    document.getElementById('overlay').classList.remove('hidden')
  }

  // Utils
  function escapeHtml(s){ return s?.replace(/[&<>\"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])) }

  // Boot
  async function boot(){ await fetchEvents(); render() }
  boot()
</script>
</body>
</html>